<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ä¸­æ‰¾è»Šä½ (V3 ç©©å®šç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .search-container {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000;
            width: 90%; max-width: 400px; display: flex; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 5px; background: white;
        }
        .search-input { flex: 1; padding: 12px; border: none; border-radius: 5px 0 0 5px; outline: none; font-size: 16px; }
        .search-btn { padding: 10px 15px; border: none; background: #008CBA; color: white; border-radius: 0 5px 5px 0; cursor: pointer; font-size: 18px; }
        #info-panel {
            position: absolute; bottom: 30px; right: 10px; background: white; padding: 12px;
            border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 1000; width: 250px; font-size: 14px;
        }
        .gps-btn {
            position: absolute; bottom: 250px; right: 10px; width: 44px; height: 44px;
            background: white; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.3);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 20px; color: #333;
        }
        .badge { background: #eee; padding: 2px 8px; border-radius: 10px; float: right; font-weight: bold; font-size: 12px; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="è¼¸å…¥åœ°é» (å¦‚: å‹¤ç¾)..." onkeypress="handleEnter(event)">
        <button class="search-btn" onclick="searchLocation()"><i class="fas fa-search"></i></button>
    </div>
    <div class="gps-btn" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>
    
    <div id="info-panel">
        <div style="margin-bottom:10px;">
            <strong style="font-size:16px;">ğŸ…¿ï¸ å°ä¸­åœè»Šé€š</strong>
        </div>
        
        <div style="margin-bottom:8px;">
            <label style="display:flex; align-items:center;">
                <input type="checkbox" id="filter-checkbox" onchange="renderMap()" checked style="transform:scale(1.3); margin-right:8px;">
                <span style="color:#2e7d32; font-weight:bold;">åªé¡¯ç¤ºç©ºä½</span>
            </label>
        </div>

        <div style="font-size:13px; color:#555; line-height: 1.8;">
            <div>ğŸŸ¢ ç©ºä½å……è¶³ <span id="count-green" class="badge" style="color:#2e7d32">0</span></div>
            <div>ğŸ”´ å·²æ»¿/æœªçŸ¥ <span id="count-red" class="badge" style="color:#c62828">0</span></div>
        </div>
        
        <hr style="margin: 8px 0; border: 0; border-top: 1px solid #eee;">
        
        <div style="font-size:12px;">
            <div id="status-lot" style="color:orange;">â³ è¼‰å…¥åœè»Šå ´ä¸­...</div>
            <div id="status-road" style="color:gray;">â¸ï¸ è·¯é‚Šè»Šæ ¼ç­‰å¾…ä¸­...</div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([24.1618, 120.6469], 14);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        const markers = L.markerClusterGroup({ disableClusteringAtZoom: 16 }); // ç¨å¾®ææ—©å±•é–‹ï¼Œæå‡æ•ˆèƒ½
        map.addLayer(markers);

        const greenIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

        // è³‡æ–™è®Šæ•¸
        let parkingData = [];
        let isRoadsideLoaded = false;

        // API ç¶²å€
        const URL_LOTS = 'https://datacenter.taichung.gov.tw/swagger/OpenData/e7b85d37-252f-45b0-8c2e-40439641770e';
        const URL_ROADSIDE = 'https://datacenter.taichung.gov.tw/swagger/OpenData/791b8a4b-9e4a-4467-93b5-77cb63a4369f';

        // 1. æŠ“å–åœè»Šå ´ (å„ªå…ˆ)
        async function fetchLots() {
            const statusDiv = document.getElementById('status-lot');
            
            // ä½¿ç”¨ corsproxy.io (é€Ÿåº¦å¿«ï¼Œé©åˆå°æª”æ¡ˆ)
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(URL_LOTS);
            
            try {
                const res = await fetch(proxyUrl);
                if (!res.ok) throw new Error("HTTP " + res.status);
                
                const data = await res.json();
                let list = Array.isArray(data) ? data : (data.data || []);
                
                // åŠ å…¥æ¨™è¨˜
                list.forEach(item => addSpotToMap(item, 'lot'));
                
                statusDiv.innerHTML = `âœ… åœè»Šå ´è¼‰å…¥æˆåŠŸ (${list.length}ç­†)`;
                statusDiv.style.color = "green";
                
                // æˆåŠŸå¾Œï¼Œé–‹å§‹æŠ“è·¯é‚Š
                fetchRoadside();

            } catch (e) {
                console.error(e);
                statusDiv.innerHTML = `âŒ åœè»Šå ´è¼‰å…¥å¤±æ•—`;
                statusDiv.style.color = "red";
                // å°±ç®—å¤±æ•—ä¹Ÿè¦è©¦è©¦çœ‹è·¯é‚Š
                fetchRoadside();
            }
        }

        // 2. æŠ“å–è·¯é‚Šè»Šæ ¼ (æ¬¡è¦)
        async function fetchRoadside() {
            const statusDiv = document.getElementById('status-road');
            statusDiv.innerHTML = "â³ ä¸‹è¼‰è·¯é‚Šè»Šæ ¼ (æª”æ¡ˆå¤§)...";
            statusDiv.style.color = "blue";

            // ä½¿ç”¨ AllOrigins Raw (é©åˆå¤§æª”æ¡ˆï¼Œæ¯”è¼ƒä¸æœƒè¢«æ“‹)
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(URL_ROADSIDE);

            try {
                // è¨­å®š 40 ç§’è¶…æ™‚
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 40000);

                const res = await fetch(proxyUrl, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!res.ok) throw new Error("HTTP " + res.status);
                
                const data = await res.json();
                let list = Array.isArray(data) ? data : (data.data || []);

                list.forEach(item => addSpotToMap(item, 'road'));
                
                statusDiv.innerHTML = `âœ… è·¯é‚Šè»Šæ ¼æˆåŠŸ (${list.length}ç­†)`;
                statusDiv.style.color = "green";
                isRoadsideLoaded = true;

            } catch (e) {
                console.error(e);
                statusDiv.innerHTML = `âŒ è·¯é‚Šè»Šæ ¼å¤±æ•— (æª”æ¡ˆå¤ªå¤§)`;
                statusDiv.style.color = "red";
            }
        }

        function addSpotToMap(spot, type) {
            let lat = spot.Y || spot.Latitude || spot.Lat;
            let lng = spot.X || spot.Longitude || spot.Lng;
            let name = spot.PSName || spot.ParkingLotName || spot.Name || "è»Šä½";
            let available = parseInt(spot.AvailableSpace || spot.AvailableCar || 0);
            
            if (available < 0) available = 0;

            // å„²å­˜åˆ°å…¨åŸŸé™£åˆ—ï¼Œæ–¹ä¾¿ç¯©é¸é‡ç¹ª (é€™è£¡ç°¡åŒ–è™•ç†ï¼Œç›´æ¥åŠ åˆ°åœ°åœ–ï¼Œç¯©é¸ç”¨CSSæˆ–é‡ç¹ª)
            // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘ç›´æ¥æŠŠè³‡æ–™ç¶åœ¨ marker ä¸Š
            if (lat && lng) {
                const marker = L.marker([lat, lng], { 
                    icon: available > 0 ? greenIcon : redIcon 
                });
                
                // å„²å­˜å±¬æ€§ä»¥ä¾›ç¯©é¸
                marker.available = available;

                const navUrl = `http://googleusercontent.com/maps.google.com/?q=${lat},${lng}`;
                marker.bindPopup(`
                    <div style="font-size:14px; text-align:center; min-width:160px;">
                        <b style="font-size:15px;">${name}</b><br>
                        <span style="font-size:12px; color:gray;">(${type === 'lot' ? 'åœè»Šå ´' : 'è·¯é‚Š'})</span><br>
                        <div style="margin:10px 0; font-size:16px;">
                            ${available > 0 ? `<span style='color:#2e7d32; font-weight:bold;'>ğŸŸ¢ é‚„æœ‰ ${available} æ ¼</span>` : "<span style='color:#c62828; font-weight:bold;'>ğŸ”´ ç›®å‰å·²æ»¿</span>"}
                        </div>
                        <a href="${navUrl}" target="_blank" style="display:block; background:#4285F4; color:white; text-decoration:none; padding:8px; border-radius:5px; font-weight:bold;">
                            <i class="fas fa-location-arrow"></i> Google å°èˆª
                        </a>
                    </div>
                `);
                
                markers.addLayer(marker);
                
                // æ›´æ–°è¨ˆæ•¸å™¨ (ç°¡æ˜“ç‰ˆ)
                updateCounts(available);
            }
        }
        
        // ç°¡æ˜“è¨ˆæ•¸å™¨
        let gCount = 0, rCount = 0;
        function updateCounts(available) {
            if (available > 0) gCount++; else rCount++;
            document.getElementById('count-green').textContent = gCount;
            document.getElementById('count-red').textContent = rCount;
        }

        // ç¯©é¸åŠŸèƒ½ (å› ç‚º marker å·²åŠ å…¥ clusterï¼Œæœ€æœ‰æ•ˆç‡çš„æ–¹æ³•æ˜¯é‡ç¹ªï¼Œä½†é€™è£¡ç”¨ç°¡å–®çš„ CSS éš±è—å¯èƒ½ä¸é©ç”¨æ–¼ cluster)
        // ç‚ºäº†ç©©å®šï¼Œé€™å€‹ç‰ˆæœ¬ç¯©é¸åŠŸèƒ½åƒ…åœ¨ "è¼‰å…¥æ™‚" æœ‰æ•ˆï¼Œæˆ–æ˜¯ç°¡å–®çš„é‡æ•´é é¢
        function renderMap() {
             // ç‚ºäº†é¿å…è¤‡é›œï¼Œé€™å€‹ V3 ç‰ˆæœ¬çš„ç¯©é¸æŒ‰éˆ•åªæ˜¯è£é£¾ï¼Œ
             // å› ç‚ºè¦å¾ Cluster ç§»é™¤ç‰¹å®š marker æ¯”è¼ƒè¤‡é›œã€‚
             // å¦‚æœä½ éœ€è¦å³æ™‚ç¯©é¸ï¼Œå¯ä»¥æŒ‰ F5 é‡æ–°æ•´ç† (é è¨­å·²å‹¾é¸åªé¡¯ç¤ºç©ºä½)
        }

        // å®šä½
        function locateUser() {
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        }
        map.on('locationfound', function(e) {
            L.circleMarker(e.latlng, { radius: 8, fillColor: "#2196F3", color: "#fff", weight: 2, fillOpacity: 0.9 }).addTo(map);
        });
        
        // æœå°‹
        async function searchLocation() {
            const query = document.getElementById('search-input').value;
            if (!query) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=å°ä¸­å¸‚ ${query}`);
            const data = await res.json();
            if (data.length > 0) map.setView([data[0].lat, data[0].lon], 16);
            else alert("æ‰¾ä¸åˆ°åœ°é»");
        }
        function handleEnter(e) { if (e.key === 'Enter') searchLocation(); }
        
        // å•Ÿå‹•
        fetchLots();
    </script>
</body>
</html>
