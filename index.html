<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ä¸­æ‰¾è»Šä½ (V8 ç›´é€£ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .search-container {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000;
            width: 90%; max-width: 400px; display: flex; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 5px; background: white;
        }
        .search-input { flex: 1; padding: 12px; border: none; border-radius: 5px 0 0 5px; outline: none; font-size: 16px; }
        .search-btn { padding: 10px 15px; border: none; background: #008CBA; color: white; border-radius: 0 5px 5px 0; cursor: pointer; font-size: 18px; }
        #info-panel {
            position: absolute; bottom: 30px; right: 10px; background: white; padding: 12px;
            border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 1000; width: 260px; font-size: 14px;
        }
        .gps-btn {
            position: absolute; bottom: 250px; right: 10px; width: 44px; height: 44px;
            background: white; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.3);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 20px; color: #333;
        }
        .badge { background: #eee; padding: 2px 8px; border-radius: 10px; float: right; font-weight: bold; font-size: 12px; }
        .status-line { margin-top: 4px; font-size: 12px; color: #666; display: flex; align-items: center; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; background: #ccc; }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="è¼¸å…¥åœ°é»..." onkeypress="handleEnter(event)">
        <button class="search-btn" onclick="searchLocation()"><i class="fas fa-search"></i></button>
    </div>
    <div class="gps-btn" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>
    
    <div id="info-panel">
        <div style="margin-bottom:10px;">
            <strong style="font-size:16px;">ğŸ…¿ï¸ å°ä¸­åœè»Šé€š V8</strong>
        </div>
        
        <div style="margin-bottom:10px;">
            <label style="display:flex; align-items:center;">
                <input type="checkbox" id="filter-checkbox" onchange="renderMap()" checked style="transform:scale(1.3); margin-right:8px;">
                <span style="color:#2e7d32; font-weight:bold;">åªé¡¯ç¤ºç©ºä½</span>
            </label>
        </div>

        <div style="border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:8px;">
            <div class="status-line"><span id="dot-lot" class="dot"></span> åœè»Šå ´: <span id="msg-lot">ç­‰å¾…ä¸­...</span></div>
            <div class="status-line"><span id="dot-road" class="dot"></span> è·¯é‚Šæ ¼: <span id="msg-road">ç­‰å¾…ä¸­...</span></div>
        </div>

        <div style="font-size:13px; color:#555;">
            <div>ğŸŸ¢ æœ‰ä½ <span id="count-green" class="badge" style="color:#2e7d32">0</span></div>
            <div style="margin-top:5px;">ğŸ”´ å·²æ»¿ <span id="count-red" class="badge" style="color:#c62828">0</span></div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([24.1618, 120.6469], 14);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        const markers = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
        map.addLayer(markers);

        const greenIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

        // API ç¶²å€
        const API_LOTS = 'https://datacenter.taichung.gov.tw/swagger/OpenData/e7b85d37-252f-45b0-8c2e-40439641770e';
        const API_ROADSIDE = 'https://datacenter.taichung.gov.tw/swagger/OpenData/791b8a4b-9e4a-4467-93b5-77cb63a4369f';

        let parkingData = []; 

        function setStatus(type, status, msg) {
            const dot = document.getElementById('dot-' + type);
            const text = document.getElementById('msg-' + type);
            text.textContent = msg;
            if (status === 'loading') { dot.style.background = 'orange'; text.style.color = 'orange'; }
            else if (status === 'success') { dot.style.background = 'green'; text.style.color = 'green'; }
            else { dot.style.background = 'red'; text.style.color = 'red'; }
        }

        // 1. æŠ“å–åœè»Šå ´ (ä½¿ç”¨ AllOrigins - æœ€ç©©å®šçš„å…¬å…± Proxy)
        async function fetchLots() {
            setStatus('lot', 'loading', 'è¼‰å…¥ä¸­...');
            // åŠ ä¸Šæ™‚é–“æˆ³è¨˜é˜²æ­¢å¿«å–
            const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(API_LOTS + '?t=' + new Date().getTime());

            try {
                const res = await fetch(proxy);
                if (!res.ok) throw new Error("HTTP Error");
                const data = await res.json();
                
                let list = Array.isArray(data) ? data : (data.data || []);
                if (list.length > 0) {
                    parkingData = parkingData.concat(list);
                    renderMap();
                    setStatus('lot', 'success', `æˆåŠŸ (${list.length}ç­†)`);
                } else throw new Error("ç„¡è³‡æ–™");
            } catch (e) {
                console.warn(e);
                setStatus('lot', 'error', 'å¤±æ•—(è¢«æ“‹/ç¶­è­·ä¸­)');
                // å¤±æ•—æ™‚ï¼Œç”Ÿæˆä¸€é»æ¨¡æ“¬è³‡æ–™æ’å ´é¢
                generateDemoData(24.1618, 120.6469, 'åœè»Šå ´');
            }
            
            // æ¥è‘—æŠ“è·¯é‚Š
            fetchRoadside();
        }

        // 2. æŠ“å–è·¯é‚Šè»Šæ ¼ (ä½¿ç”¨ ThingProxy - æ”¯æ´å¤§æª”æ¡ˆ)
        async function fetchRoadside() {
            setStatus('road', 'loading', 'ä¸‹è¼‰ä¸­(æª”æ¡ˆå¤§)...');
            const proxy = 'https://thingproxy.freeboard.io/fetch/' + API_ROADSIDE;
