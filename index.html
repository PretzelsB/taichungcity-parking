<script>
        // --- 1. åˆå§‹åŒ–åœ°åœ– ---
        const map = L.map('map', { zoomControl: false }).setView([24.1618, 120.6469], 14);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        const markers = L.markerClusterGroup({ disableClusteringAtZoom: 17 });
        map.addLayer(markers);

        let userMarker = null;

        // --- 2. å®šç¾©åœ–ç¤º ---
        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });
        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // --- 3. è¨­å®š API (æ”¹ç”¨ AllOrigins JSON æ¨¡å¼ï¼Œç›¸å®¹æ€§æœ€é«˜) ---
        const TARGET_API = 'https://datacenter.taichung.gov.tw/swagger/OpenData/791b8a4b-9e4a-4467-93b5-77cb63a4369f';
        // ä½¿ç”¨ get?url= æ¨¡å¼ï¼Œå®ƒæœƒæŠŠè³‡æ–™åŒ…åœ¨ contents è£¡é¢å›å‚³
        const PROXY_URL = 'https://api.allorigins.win/get?url=' + encodeURIComponent(TARGET_API);
        
        let allParkingData = [];
        let countdown = 60;
        let updateInterval;

        // --- 4. æŠ“å–è³‡æ–™å‡½å¼ (é‡è¦ä¿®æ”¹) ---
        async function fetchParkingData() {
            resetTimer(); 
            const timerLabel = document.getElementById('update-timer');
            timerLabel.textContent = "æ›´æ–°ä¸­...";
            timerLabel.style.color = "blue";

            try {
                // 1. ç™¼é€è«‹æ±‚çµ¦ä»£ç†ä¼ºæœå™¨
                const response = await fetch(PROXY_URL);
                if (!response.ok) throw new Error("ä»£ç†é€£ç·šéŒ¯èª¤: " + response.status);

                // 2. å–å¾—åŒ…è£éçš„è³‡æ–™ (Wrapper)
                const wrapper = await response.json();
                
                // 3. å¾ wrapper.contents å–å‡ºçœŸæ­£çš„è³‡æ–™å­—ä¸²ä¸¦è½‰æˆ JSON
                if (!wrapper.contents) throw new Error("ä»£ç†ä¼ºæœå™¨å›å‚³ç©ºå€¼");
                
                // é€™è£¡æœ‰æ™‚å€™æœƒå›å‚³å­—ä¸²ï¼Œæœ‰æ™‚å€™æ˜¯ç‰©ä»¶ï¼Œåšå€‹é˜²å‘†
                if (typeof wrapper.contents === 'string') {
                    allParkingData = JSON.parse(wrapper.contents);
                } else {
                    allParkingData = wrapper.contents;
                }

                // 4. æª¢æŸ¥è³‡æ–™æ˜¯å¦æœ‰æ•ˆ
                if (!Array.isArray(allParkingData)) {
                     // å˜—è©¦å°‹æ‰¾æ˜¯å¦åœ¨æŸå€‹å±¬æ€§ä¸‹ (ä¾‹å¦‚ .data)
                     if (allParkingData.data) allParkingData = allParkingData.data;
                     else throw new Error("è³‡æ–™æ ¼å¼ä¸æ­£ç¢º (éé™£åˆ—)");
                }

                renderMap(); 
                
                const now = new Date();
                timerLabel.textContent = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')} æ›´æ–°`;
                timerLabel.style.color = "#666";

            } catch (error) {
                console.error("Fetch error details:", error);
                timerLabel.textContent = "âš ï¸ é€£ç·šå¤±æ•—";
                timerLabel.style.color = "red";
                
                // é¡¯ç¤ºæ›´æ¸…æ¥šçš„éŒ¯èª¤è¨Šæ¯ï¼Œæ–¹ä¾¿é™¤éŒ¯
                // alert("è®€å–å¤±æ•— (AllOrigins):\n" + error.message);
                
                // å¤±æ•—å¾Œ 5 ç§’é‡è©¦
                setTimeout(fetchParkingData, 5000); 
            }
        }

        // --- 5. æ¸²æŸ“åœ°åœ–å‡½å¼ ---
        function renderMap() {
            markers.clearLayers();
            const showOnlyAvailable = document.getElementById('filter-checkbox').checked;
            
            let greenCount = 0;
            let redCount = 0;

            allParkingData.forEach(spot => {
                let lat = spot.Y || spot.Latitude;
                let lng = spot.X || spot.Longitude;
                let name = spot.PSName || spot.ParkingLotName || "è»Šä½";
                let available = parseInt(spot.AvailableSpace || 0);
                if (available < 0) available = 0;

                if (available > 0) greenCount++;
                else redCount++;

                if (showOnlyAvailable && available === 0) return;

                if (lat && lng) {
                    const marker = L.marker([lat, lng], {
                        icon: available > 0 ? greenIcon : redIcon
                    });
                    
                    const navUrl = `http://googleusercontent.com/maps.google.com/?q=${lat},${lng}`;

                    marker.bindPopup(`
                        <div style="font-size:14px; text-align:center; min-width:160px;">
                            <b style="font-size:15px;">${name}</b><br>
                            <div style="margin:10px 0; font-size:16px;">
                                ${available > 0 
                                    ? `<span style='color:#2e7d32; font-weight:bold;'>ğŸŸ¢ é‚„æœ‰ ${available} æ ¼</span>` 
                                    : "<span style='color:#c62828; font-weight:bold;'>ğŸ”´ ç›®å‰å·²æ»¿</span>"}
                            </div>
                            <a href="${navUrl}" 
                               target="_blank" 
                               style="display:block; background:#4285F4; color:white; text-decoration:none; padding:8px; border-radius:5px; font-weight:bold;">
                                <i class="fas fa-location-arrow"></i> Google å°èˆª
                            </a>
                        </div>
                    `);
                    markers.addLayer(marker);
                }
            });

            document.getElementById('count-green').textContent = greenCount;
            document.getElementById('count-red').textContent = redCount;
        }

        // --- 6. å€’æ•¸è¨ˆæ™‚å™¨ ---
        function resetTimer() {
            if (updateInterval) clearInterval(updateInterval);
            countdown = 60;
            const fill = document.getElementById('progress-fill');
            fill.style.transition = 'none';
            fill.style.width = '100%';
            void fill.offsetWidth; 
            fill.style.transition = 'width 1s linear';
            
            updateInterval = setInterval(() => {
                countdown--;
                const percent = (countdown / 60) * 100;
                fill.style.width = `${percent}%`;

                if (countdown <= 0) {
                    clearInterval(updateInterval);
                    fetchParkingData();
                }
            }, 1000);
        }

        // --- 7. GPS å®šä½ ---
        function locateUser() {
            const btn = document.querySelector('.gps-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 

            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        }

        map.on('locationfound', function(e) {
            document.querySelector('.gps-btn').innerHTML = '<i class="fas fa-crosshairs"></i>';
            document.querySelector('.gps-btn').classList.add('gps-active');

            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(e.latlng, {
                radius: 8, fillColor: "#2196F3", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9
            }).addTo(map);
            L.circle(e.latlng, e.accuracy / 2, { color: '#2196F3', fillOpacity: 0.1 }).addTo(map);
        });

        map.on('locationerror', function(e) {
            alert("ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹ç¢ºèªç€è¦½å™¨ GPS æ¬Šé™å·²é–‹å•Ÿã€‚");
            document.querySelector('.gps-btn').innerHTML = '<i class="fas fa-crosshairs"></i>';
        });

        // --- 8. åœ°é»æœå°‹ ---
        async function searchLocation() {
            const input = document.getElementById('search-input');
            const query = input.value.trim();
            if (!query) return;

            const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=å°ä¸­å¸‚ ${query}`;

            try {
                const res = await fetch(searchUrl);
                const data = await res.json();
                if (data && data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    map.setView([lat, lon], 16);
                } else {
                    alert("æ‰¾ä¸åˆ°åœ°é»ï¼Œè«‹å˜—è©¦æ›´å…·é«”çš„åç¨±");
                }
            } catch (e) {
                alert("æœå°‹æœå‹™ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') searchLocation();
        }

        // å•Ÿå‹•ç¨‹å¼
        fetchParkingData();

    </script>
