<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ä¸­æ‰¾è»Šä½ (V6 ç«‹å³å±•ç¤ºç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .search-container {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000;
            width: 90%; max-width: 400px; display: flex; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 5px; background: white;
        }
        .search-input { flex: 1; padding: 12px; border: none; border-radius: 5px 0 0 5px; outline: none; font-size: 16px; }
        .search-btn { padding: 10px 15px; border: none; background: #008CBA; color: white; border-radius: 0 5px 5px 0; cursor: pointer; font-size: 18px; }
        #info-panel {
            position: absolute; bottom: 30px; right: 10px; background: white; padding: 12px;
            border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 1000; width: 260px; font-size: 14px;
        }
        .gps-btn {
            position: absolute; bottom: 250px; right: 10px; width: 44px; height: 44px;
            background: white; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.3);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 20px; color: #333;
        }
        .badge { background: #eee; padding: 2px 8px; border-radius: 10px; float: right; font-weight: bold; font-size: 12px; }
        .demo-tag { background: #ffeb3b; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; display:inline-block; margin-left: 5px;}
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="è¼¸å…¥åœ°é»..." onkeypress="handleEnter(event)">
        <button class="search-btn" onclick="searchLocation()"><i class="fas fa-search"></i></button>
    </div>
    <div class="gps-btn" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>
    
    <div id="info-panel">
        <div style="margin-bottom:10px;">
            <strong style="font-size:16px;">ğŸ…¿ï¸ å°ä¸­åœè»Šé€š</strong>
            <span class="demo-tag">é«”é©—æ¨¡å¼</span>
        </div>
        
        <div style="margin-bottom:10px;">
            <label style="display:flex; align-items:center;">
                <input type="checkbox" id="filter-checkbox" onchange="renderMap()" checked style="transform:scale(1.3); margin-right:8px;">
                <span style="color:#2e7d32; font-weight:bold;">åªé¡¯ç¤ºç©ºä½</span>
            </label>
        </div>

        <div style="font-size:13px; color:#555; line-height: 1.8;">
            <div>ğŸŸ¢ æœ‰ä½ <span id="count-green" class="badge" style="color:#2e7d32">0</span></div>
            <div>ğŸ”´ å·²æ»¿ <span id="count-red" class="badge" style="color:#c62828">0</span></div>
        </div>
        
        <div id="status-msg" style="margin-top:8px; font-size:12px; color:green; border-top:1px solid #eee; padding-top:5px;">
            âœ… ç³»çµ±å°±ç·’
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        // 1. åˆå§‹åŒ–åœ°åœ– (é è¨­å°ä¸­å¸‚æ”¿åºœ)
        const defaultLat = 24.1618;
        const defaultLng = 120.6469;
        const map = L.map('map', { zoomControl: false }).setView([defaultLat, defaultLng], 15);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        
        const markers = L.markerClusterGroup();
        map.addLayer(markers);

        const greenIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

        let parkingData = [];
        let userMarker = null;

        // 2. æ ¸å¿ƒåŠŸèƒ½ï¼šç›´æ¥ç”Ÿæˆæ¨¡æ“¬è³‡æ–™ (ä¸éœ€é€£ç¶²)
        function generateDemoData(centerLat, centerLng) {
            parkingData = [];
            const count = 50; // ç”Ÿæˆ 50 å€‹é»
            
            for(let i=0; i<count; i++) {
                // åœ¨ä¸­å¿ƒé»é™„è¿‘ 800å…¬å°ºå…§éš¨æ©Ÿåˆ†ä½ˆ
                let rLat = centerLat + (Math.random() - 0.5) * 0.015;
                let rLng = centerLng + (Math.random() - 0.5) * 0.015;
                
                // æ¨¡æ“¬ 70% æœ‰ä½å­ï¼Œ30% å®¢æ»¿
                let isFull = Math.random() > 0.7;
                let spaces = isFull ? 0 : Math.floor(Math.random() * 20) + 1;
                
                parkingData.push({
                    Name: isFull ? `è·¯é‚Šæ ¼-${i} (å·²æ»¿)` : `è·¯é‚Šæ ¼-${i}`,
                    Lat: rLat,
                    Lng: rLng,
                    AvailableSpace: spaces,
                    Type: Math.random() > 0.8 ? 'åœè»Šå ´' : 'è·¯é‚Š'
                });
            }
            renderMap();
            document.getElementById('status-msg').textContent = `âœ… å·²é¡¯ç¤º ${count} å€‹æ¨¡æ“¬è»Šä½`;
        }

        // 3. ç•«åœ°åœ–
        function renderMap() {
            markers.clearLayers();
            const showOnlyAvailable = document.getElementById('filter-checkbox').checked;
            let greenCount = 0, redCount = 0;

            parkingData.forEach(spot => {
                if (spot.AvailableSpace > 0) greenCount++; else redCount++;
                
                // ç¯©é¸
                if (showOnlyAvailable && spot.AvailableSpace === 0) return;

                const marker = L.marker([spot.Lat, spot.Lng], { 
                    icon: spot.AvailableSpace > 0 ? greenIcon : redIcon 
                });
                
                const navUrl = `http://googleusercontent.com/maps.google.com/?q=${spot.Lat},${spot.Lng}`;
                
                marker.bindPopup(`
                    <div style="text-align:center; min-width:150px;">
                        <b style="font-size:15px;">${spot.Name}</b><br>
                        <span style="font-size:12px; color:gray;">(${spot.Type})</span>
                        <div style="margin:8px 0; font-size:16px;">
                            ${spot.AvailableSpace > 0 
                                ? `<span style='color:#2e7d32; font-weight:bold;'>ğŸŸ¢ é‚„æœ‰ ${spot.AvailableSpace} æ ¼</span>` 
                                : "<span style='color:#c62828; font-weight:bold;'>ğŸ”´ ç›®å‰å·²æ»¿</span>"}
                        </div>
                        <a href="${navUrl}" target="_blank" style="display:block; background:#4285F4; color:white; padding:6px; border-radius:4px; text-decoration:none;">
                            å°èˆªå»é€™è£¡
                        </a>
                    </div>
                `);
                markers.addLayer(marker);
            });
            
            document.getElementById('count-green').textContent = greenCount;
            document.getElementById('count-red').textContent = redCount;
        }

        // 4. å®šä½åŠŸèƒ½ (èƒŒæ™¯åŸ·è¡Œï¼Œä¸å¡ç•«é¢)
        function locateUser() {
            document.getElementById('status-msg').textContent = "ğŸ“ å®šä½ä¸­ (è«‹å…è¨±æ¬Šé™)...";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        }
        
        map.on('locationfound', function(e) {
            document.getElementById('status-msg').textContent = "ğŸ“ å®šä½æˆåŠŸï¼æ›´æ–°è»Šä½ä¸­...";
            
            // ç•«å‡ºä½¿ç”¨è€…ä½ç½®
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(e.latlng, { radius: 8, fillColor: "#2196F3", color: "#fff", weight: 2, fillOpacity: 0.9 }).addTo(map);
            L.circle(e.latlng, e.accuracy / 2).addTo(map);
            
            // é£›åˆ°ä½¿ç”¨è€…ä½ç½®ï¼Œä¸¦åœ¨é‚£é‚Šé‡æ–°ç”Ÿæˆè³‡æ–™
            // map.setView(e.latlng, 16); // locate å·²ç¶“æœ‰ setView: true
            generateDemoData(e.latlng.lat, e.latlng.lng);
        });
        
        map.on('locationerror', (e) => {
            console.warn(e);
            document.getElementById('status-msg').textContent = "âš ï¸ å®šä½å¤±æ•— (è«‹æª¢æŸ¥GPSæ¬Šé™)";
            alert("ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦å°é–äº†å®šä½æ¬Šé™ã€‚");
        });

        // 5. æœå°‹åŠŸèƒ½
        async function searchLocation() {
            const query = document.getElementById('search-input').value;
            if (!query) return;
            document.getElementById('status-msg').textContent = "ğŸ” æœå°‹ä¸­...";
            
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=å°ä¸­å¸‚ ${query}`);
                const data = await res.json();
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 16);
                    generateDemoData(lat, lon); // åœ¨æœå°‹åœ°é»ç”Ÿæˆè³‡æ–™
                } else {
                    alert("æ‰¾ä¸åˆ°åœ°é»");
                }
            } catch(e) {
                alert("æœå°‹é€£ç·šéŒ¯èª¤");
            }
        }
        function handleEnter(e) { if (e.key === 'Enter') searchLocation(); }
        
        // --- ç¨‹å¼å•Ÿå‹• ---
        // å…ˆç”Ÿæˆä¸€æ¬¡é è¨­è³‡æ–™ï¼Œè®“ç•«é¢æœ‰æ±è¥¿
        generateDemoData(defaultLat, defaultLng);
        
        // ç„¶å¾Œå†å˜—è©¦å®šä½ (å¦‚æœä¸æˆåŠŸä¹Ÿæ²’é—œä¿‚ï¼Œè‡³å°‘å·²æœ‰ç•«é¢)
        locateUser();

    </script>
</body>
</html>
