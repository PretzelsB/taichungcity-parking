<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ä¸­æ‰¾è»Šä½ (å¤šç·šè·¯ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .search-container {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000;
            width: 90%; max-width: 400px; display: flex; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 5px; background: white;
        }
        .search-input { flex: 1; padding: 12px; border: none; border-radius: 5px 0 0 5px; outline: none; font-size: 16px; }
        .search-btn { padding: 10px 15px; border: none; background: #008CBA; color: white; border-radius: 0 5px 5px 0; cursor: pointer; font-size: 18px; }
        #info-panel {
            position: absolute; bottom: 30px; right: 10px; background: white; padding: 12px;
            border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 1000; width: 220px; font-size: 14px;
        }
        .gps-btn {
            position: absolute; bottom: 250px; right: 10px; width: 44px; height: 44px;
            background: white; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.3);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 20px; color: #333;
        }
        .progress-bar { height: 4px; background: #eee; margin-top: 10px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: #008CBA; width: 100%; transition: width 1s linear; }
        .toggle-row { display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; padding: 5px; background: #f1f8e9; border-radius: 5px; }
        .toggle-row input { margin-right: 8px; transform: scale(1.3); cursor: pointer; }
        .badge { background: #eee; padding: 2px 8px; border-radius: 10px; float: right; font-weight: bold; font-size: 12px; }
        
        /* éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºå€ */
        #debug-info {
            font-size: 10px; color: red; margin-top: 5px; max-height: 50px; overflow-y: auto; display: none;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="è¼¸å…¥åœ°é» (å¦‚: å‹¤ç¾)..." onkeypress="handleEnter(event)">
        <button class="search-btn" onclick="searchLocation()"><i class="fas fa-search"></i></button>
    </div>
    <div class="gps-btn" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>
    <div id="info-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <strong style="font-size:16px;">ğŸ…¿ï¸ å°ä¸­åœè»Šé€š</strong>
            <span id="update-timer" style="color:#666; font-size:12px;">æº–å‚™ä¸­...</span>
        </div>
        <div class="toggle-row" onclick="document.getElementById('filter-checkbox').click()">
            <input type="checkbox" id="filter-checkbox" onchange="renderMap()" checked onclick="event.stopPropagation()">
            <label style="color:#2e7d32; font-weight:bold; cursor:pointer;">åªé¡¯ç¤ºç©ºä½</label>
        </div>
        <div style="font-size:13px; color:#555; margin-top:8px; line-height: 1.6;">
            <div>ğŸŸ¢ ç©ºä½å……è¶³ <span id="count-green" class="badge" style="color:#2e7d32">0</span></div>
            <div>ğŸ”´ å·²æ»¿/æœªçŸ¥ <span id="count-red" class="badge" style="color:#c62828">0</span></div>
        </div>
        <div id="debug-info"></div>
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([24.1618, 120.6469], 14);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        const markers = L.markerClusterGroup({ disableClusteringAtZoom: 17 });
        map.addLayer(markers);
        let userMarker = null;

        const greenIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

        // --- è¨­å®šå¤šå€‹ä»£ç†ç·šè·¯ ---
        const TARGET_API = 'https://datacenter.taichung.gov.tw/swagger/OpenData/791b8a4b-9e4a-4467-93b5-77cb63a4369f';
        const PROXIES = [
            // ç·šè·¯ 1: AllOrigins Raw
            (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            // ç·šè·¯ 2: CorsProxy.io
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            // ç·šè·¯ 3: ThingProxy
            (url) => `https://thingproxy.freeboard.io/fetch/${url}`
        ];
        
        let allParkingData = [];
        let countdown = 60;
        let updateInterval;

        // æ ¸å¿ƒï¼šå˜—è©¦æŠ“å–è³‡æ–™ (è‡ªå‹•åˆ‡æ›)
        async function fetchParkingData() {
            resetTimer(); 
            const timerLabel = document.getElementById('update-timer');
            const debugDiv = document.getElementById('debug-info');
            debugDiv.style.display = 'none';
            debugDiv.innerText = '';

            let success = false;

            // è¿´åœˆå˜—è©¦æ‰€æœ‰ç·šè·¯
            for (let i = 0; i < PROXIES.length; i++) {
                if (success) break; // å¦‚æœæˆåŠŸäº†å°±è·³å‡º

                const proxyUrl = PROXIES[i](TARGET_API);
                timerLabel.textContent = `å˜—è©¦ç·šè·¯ ${i + 1}...`;
                timerLabel.style.color = "blue";

                try {
                    // è¨­å®š 10 ç§’è¶…æ™‚ï¼Œé¿å…å¡å¤ªä¹…
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);

                    const response = await fetch(proxyUrl, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const textData = await response.text();
                    
                    try {
                        let jsonData = JSON.parse(textData);
                        // AllOrigins å¯èƒ½æœƒå›å‚³ contents åŒ…è£¹
                        if (jsonData.contents && typeof jsonData.contents === 'string') {
                            jsonData = JSON.parse(jsonData.contents);
                        } else if (jsonData.contents) {
                            jsonData = jsonData.contents;
                        }

                        // æª¢æŸ¥æ˜¯ä¸æ˜¯é™£åˆ—
                        if (Array.isArray(jsonData)) {
                            allParkingData = jsonData;
                            success = true; // æˆåŠŸï¼
                        } else if (jsonData.data && Array.isArray(jsonData.data)) {
                            allParkingData = jsonData.data;
                            success = true;
                        } else {
                            throw new Error("æ ¼å¼éŒ¯èª¤");
                        }

                    } catch (e) {
                        throw new Error("JSON è§£æå¤±æ•—");
                    }

                } catch (error) {
                    console.warn(`ç·šè·¯ ${i + 1} å¤±æ•—:`, error);
                    debugDiv.style.display = 'block';
                    debugDiv.innerText += `L${i+1} fail: ${error.message}\n`;
                }
            }

            if (success) {
                renderMap(); 
                const now = new Date();
                timerLabel.textContent = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')} æ›´æ–°`;
                timerLabel.style.color = "#666";
                debugDiv.style.display = 'none'; // éš±è—éŒ¯èª¤è¨Šæ¯
            } else {
                timerLabel.textContent = "âš ï¸ å…¨éƒ¨é€£ç·šå¤±æ•—";
                timerLabel.style.color = "red";
                // 15 ç§’å¾Œé‡è©¦
                setTimeout(fetchParkingData, 15000); 
            }
        }

        function renderMap() {
            markers.clearLayers();
            const showOnlyAvailable = document.getElementById('filter-checkbox').checked;
            let greenCount = 0;
            let redCount = 0;
            
            if (!Array.isArray(allParkingData)) return;

            allParkingData.forEach(spot => {
                let lat = spot.Y || spot.Latitude;
                let lng = spot.X || spot.Longitude;
                let name = spot.PSName || spot.ParkingLotName || "è»Šä½";
                let available = parseInt(spot.AvailableSpace || 0);
                if (available < 0) available = 0;

                if (available > 0) greenCount++; else redCount++;
                if (showOnlyAvailable && available === 0) return;

                if (lat && lng) {
                    const marker = L.marker([lat, lng], { icon: available > 0 ? greenIcon : redIcon });
                    const navUrl = `http://googleusercontent.com/maps.google.com/?q=${lat},${lng}`;
                    marker.bindPopup(`
                        <div style="font-size:14px; text-align:center; min-width:160px;">
                            <b style="font-size:15px;">${name}</b><br>
                            <div style="margin:10px 0; font-size:16px;">
                                ${available > 0 ? `<span style='color:#2e7d32; font-weight:bold;'>ğŸŸ¢ é‚„æœ‰ ${available} æ ¼</span>` : "<span style='color:#c62828; font-weight:bold;'>ğŸ”´ ç›®å‰å·²æ»¿</span>"}
                            </div>
                            <a href="${navUrl}" target="_blank" style="display:block; background:#4285F4; color:white; text-decoration:none; padding:8px; border-radius:5px; font-weight:bold;">
                                <i class="fas fa-location-arrow"></i> Google å°èˆª
                            </a>
                        </div>
                    `);
                    markers.addLayer(marker);
                }
            });
            document.getElementById('count-green').textContent = greenCount;
            document.getElementById('count-red').textContent = redCount;
        }

        function resetTimer() {
            if (updateInterval) clearInterval(updateInterval);
            countdown = 60;
            const fill = document.getElementById('progress-fill');
            fill.style.transition = 'none'; fill.style.width = '100%'; void fill.offsetWidth; 
            fill.style.transition = 'width 1s linear';
            updateInterval = setInterval(() => {
                countdown--;
                const fill = document.getElementById('progress-fill'); 
                if(fill) {
                    const percent = (countdown / 60) * 100;
                    fill.style.width = `${percent}%`;
                }
                if (countdown <= 0) { clearInterval(updateInterval); fetchParkingData(); }
            }, 1000);
        }

        function locateUser() {
            const btn = document.querySelector('.gps-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        }
        map.on('locationfound', function(e) {
            document.querySelector('.gps-btn').innerHTML = '<i class="fas fa-crosshairs"></i>';
            document.querySelector('.gps-btn').classList.add('gps-active');
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(e.latlng, { radius: 8, fillColor: "#2196F3", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9 }).addTo(map);
            L.circle(e.latlng, e.accuracy / 2, { color: '#2196F3', fillOpacity: 0.1 }).addTo(map);
        });
        map.on('locationerror', function(e) {
            alert("ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹ç¢ºèªç€è¦½å™¨ GPS æ¬Šé™å·²é–‹å•Ÿã€‚");
            document.querySelector('.gps-btn').innerHTML = '<i class="fas fa-crosshairs"></i>';
        });
        async function searchLocation() {
            const input = document.getElementById('search-input');
            const query = input.value.trim();
            if (!query) return;
            const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=å°ä¸­å¸‚ ${query}`;
            try {
                const res = await fetch(searchUrl);
                const data = await res.json();
                if (data && data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    map.setView([lat, lon], 16);
                } else { alert("æ‰¾ä¸åˆ°åœ°é»ï¼Œè«‹å˜—è©¦æ›´å…·é«”çš„åç¨±"); }
            } catch (e) { alert("æœå°‹æœå‹™ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦"); }
        }
        function handleEnter(e) { if (e.key === 'Enter') searchLocation(); }

        fetchParkingData();
    </script>
</body>
</html>
